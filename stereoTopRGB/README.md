# PhytoOracle's StereoTop RGB Pipeline

#### Outline

Welcome to PhytoOracle's StereoTop RGB pipeline! This pipeline uses the data transformers from the [PhytoOracle group](https://github.com/phytooracle) extract individual plant locations and bounding box area. PhytoOracle's StereoTopRGB was primarily built to process data from the University of Arizona's gantry system, the world's largest robotic field scanner. The StereoTop RGB pipeline is avaiable for either HPC (High Performance Computing) systems or cloud based systems.

#### Transformers used

FlirIr currently uses 3 different transformers for data conversion:

| Order |                         Transformer                          |                   Process                    |
| :---: | :----------------------------------------------------------: | :------------------------------------------: |
|   1   | [rgb_bin_to_tif](https://github.com/phytooracle/rgb_bin_to_tif) | Converts bin files to geoTIFFs |
|   2   | [image_stitching](https://github.com/ariyanzri/Lettuce_Image_Stitching) | Corrects initial, noisy GPS coordinates within geoTIFFs |
|   3   | [rgb_flir_edit_gps](https://github.com/phytooracle/rgb_flir_edit_gps) | Writes corrected GPS coordinates to geoTIFFs |
|   4   | [rgb_flir_plot_clip_geojson](https://github.com/phytooracle/rgb_flir_plot_clip_geojson) | Clips GeoTIFFs to agricultural plots |
|   5   | [rgb_flir_stitch_plots](https://github.com/phytooracle/rgb_flir_stitch_plots) | Aggregates individual, clipped GeoTIFFs to plot-level orthomosaics | 
|   6   | [rgb_flir_plant_detection](https://github.com/phytooracle/rgb_flir_plant_detection) | Detects individual lettuces and outputs locations, bounding areas | 

#### Data overview

PhytoOracle's StereoTop RGB requires a metadata file (`<metadata>.json`) for every compressed image file (`<image>.bin`). Each folder (one scan) contains one metadata file and 2 compressed images, one taken from a left camera and one taken from a right camera. We provide publicly-available data in the [CyVerse DataStore](https://datacommons.cyverse.org/browse/iplant/home/shared/terraref/ua-mac/raw_tars).

#### Setup Guide
1. Download [CCTools](http://www3.nd.edu/~ccl/software/files/cctools-7.1.6-x86_64-centos7.tar.gz) and extract it's contents within your HPC home path:
```
wget http://www3.nd.edu/~ccl/software/files/cctools-7.1.6-x86_64-centos7.tar.gz

tar -xvf cctools-7.1.6-x86_64-centos7.tar.gz
```        

2. Clone this repository within your HPCs storage space such as /xdisk:
```
git clone https://github.com/LyonsLab/PhytoOracle.git
```

3. Go to stereoTopRGB:
```
cd PhytoOracle/stereoTopRGB/
```
4. Download required vector and ML model files:
```
iget -N 0 -PVT /iplant/home/shared/terraref/ua-mac/raw_tars/season_10_yr_2020/gcp_season_10.txt

iget -N 0 -PVT /iplant/home/shared/terraref/ua-mac/raw_tars/season_10_yr_2020/season10_multi_latlon_geno.geojson

iget -N 0 -PVT /iplant/home/shared/terraref/ua-mac/raw_tars/season_10_yr_2020/model_weights.pth
```


#### Running pipeline on HPC 
4. Launch workers:

-If using PBS: 
```
qsub worker_scripts/po_work_ocelote.pbs
```
-If using SLURM:
```
sbatch worker_scripts/po_work_puma.sh
```

5. Download input data:
```
iget -rKVP /iplant/home/shared/terraref/ua-mac/raw_tars/season_10_yr_2020/stereoTop/<day>.tar
```

Replace `<day>` with any day you want to process. Un-tar and move the folder to the FlirIr directory.

```
tar -xvf <day>.tar
mv stereoTop/<day> .
```

6. You're now ready to run the pipeline:
```
./run.sh <day> .
```

#### Running on the Cloud with HPC support

Although very similar to the steps above,  to run PhytoOracle on the Cloud with HPC support, there are a few extra steps  you have to carry out for data staging before starting the pipeline with `./entrypoint.sh`.

Using your favouring editing tool do

```bash
/etc/nginx/sites-available/phyto_oracle.conf
```

paste the next snipped and save (changing the highlighted `<fields>`)

```bash
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root <PATH/TO/YOUR/PHYTOORACLE/PIPELINE>;

        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                auth_basic "PhytoOracle Data";
        auth_basic_user_file /etc/apache2/.htpasswd;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
                autoindex on;
        }
}
```

then from within your Transformer directory do `./nginx_reload.sh`. Input your password if asked.

Open and edit `process_one_set.sh` : 

- delete the `#` on lines 44, 45, 46, 47
- remove `${HPC_PATH}` on lines 23, 24, 25
