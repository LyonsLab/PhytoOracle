
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Instruction manual for StereoTopRGB workflow &#8212; PhytoOracle 1.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="instruction-manual-for-stereotoprgb-workflow">
<h1>Instruction manual for StereoTopRGB workflow<a class="headerlink" href="#instruction-manual-for-stereotoprgb-workflow" title="Permalink to this headline">Â¶</a></h1>
<a class="reference internal image-reference" href="old_docs/../pics/rgb_concept_map.png"><img alt="old_docs/../pics/rgb_concept_map.png" src="old_docs/../pics/rgb_concept_map.png" style="width: 400px;" /></a>
<p><strong>Staging Data on Master Instance</strong></p>
<ul class="simple">
<li><p>Git Clone the PhytoOracle github repository.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">uacic</span><span class="o">/</span><span class="n">PhytoOracle</span>
<span class="n">cd</span> <span class="n">PhytoOracle</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">dev</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Download test data (tarball), and decompress it</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iinit</span> <span class="c1"># Enter your iRODS credentials</span>
<span class="n">cd</span> <span class="n">stereoTop</span>
<span class="n">iget</span> <span class="o">-</span><span class="n">K</span> <span class="o">/</span><span class="n">iplant</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">iplantcollaborative</span><span class="o">/</span><span class="n">example_data</span><span class="o">/</span><span class="n">starTerra</span><span class="o">/</span><span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15_5</span><span class="n">sets</span><span class="o">.</span><span class="n">tar</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xvf</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15_5</span><span class="n">sets</span><span class="o">.</span><span class="n">tar</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>you can also get the data via other methods, as along as the data is in this directory (<cite>PhytoOracle/stereoTop</cite>), and follows the same folder structure.</p>
</div>
<ul class="simple">
<li><p>Hosting data on a HTTP Server (Nginx)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span> <span class="n">apache2</span><span class="o">-</span><span class="n">utils</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">uacic</span><span class="o">/</span><span class="n">PhytoOracle</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">phyto_oracle</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">phyto_oracle</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">phyto_oracle</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">phyto_oracle</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">phyto_oracle</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">default</span>
<span class="n">sudo</span> <span class="n">nginx</span> <span class="o">-</span><span class="n">s</span> <span class="n">reload</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Set username and password for the HTTP file server</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">htpasswd</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/.</span><span class="n">htpasswd</span> <span class="n">YOUR_USERNAME</span> <span class="c1"># Set password</span>
</pre></div>
</div>
<ul class="simple">
<li><p>In the file <cite>/etc/nginx/sites-available/phyto_oracle.conf</cite>, change the line (~line 21) to the destination path to where the data is to be decompressed, e.g. <cite>/home/uacic/PhytoOracle/stereoTop</cite></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">www</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Change permissions of the data to allow serving by the HTTP server</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="o">+</span><span class="n">r</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15</span><span class="o">/*</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Change URL inside <cite>main_wf.php</cite> (~line 30) to the IP address or URL of the Master VM instance with HTTP server</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>URL needs to have slash at the end</strong></p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$DATA_BASE_URL = &quot;http://vm142-80.cyverse.org/&quot;;
</pre></div>
</div>
<ul class="simple">
<li><p>Change username and password inside <cite>process_one_set.sh</cite> (~line 27) to the ones that you set above</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP_USER</span><span class="o">=</span><span class="s2">&quot;YOUR_USERNAME&quot;</span>
<span class="n">HTTP_PASSWORD</span><span class="o">=</span><span class="s2">&quot;PhytoOracle&quot;</span>
</pre></div>
</div>
<p><strong>Generating workflow `json` on Master instance</strong></p>
<ul class="simple">
<li><p>Generate a list of the input raw-data files <cite>raw_data_files.jx</cite> from a local path as below</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">gen_files_list</span><span class="o">.</span><span class="n">py</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15</span><span class="o">/</span> <span class="o">&gt;</span>  <span class="n">raw_data_files</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Generate a <cite>json</cite> workflow using the <cite>main_wf.php</cite> script. The <cite>main_wf.php</cite> scripts parses the <cite>raw_data_files.json</cite> file created above.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php</span><span class="o">-</span><span class="n">cli</span>
<span class="n">php</span> <span class="n">main_wf_phase1</span><span class="o">.</span><span class="n">php</span> <span class="o">&gt;</span> <span class="n">main_wf_phase1</span><span class="o">.</span><span class="n">jx</span>
<span class="n">jx2json</span> <span class="n">main_wf_phase1</span><span class="o">.</span><span class="n">jx</span> <span class="o">&gt;</span> <span class="n">main_workflow_phase1</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p><strong>Run the workflow on Master</strong></p>
<ul class="simple">
<li><p>Run the workflow using the following entrypoint bash script</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">755</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<ul class="simple">
<li><p>At this point, the Master will broadcast jobs on a catalog server and wait for Workers to connect. <strong>Note the IP ADDRESS of the VM and the PORT number on which makeflow is listening, mostly `9123`</strong>. We will need it to tell the workers where to find our Master.</p></li>
</ul>
<p><strong>Connecting Worker Factories to Master</strong></p>
<ul class="simple">
<li><p>Launch one or more large instances with CCTools and Singularity installed as instructed above.</p></li>
<li><p>Connect a Worker Factory using the command as below</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">work_queue_factory</span> <span class="o">-</span><span class="n">T</span> <span class="n">local</span> <span class="n">IP_ADDRESS</span> <span class="mi">9123</span> <span class="o">-</span><span class="n">w</span> <span class="mi">40</span> <span class="o">-</span><span class="n">W</span> <span class="mi">44</span> <span class="o">--</span><span class="n">workers</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">cycle</span> <span class="mi">10</span>  <span class="o">-</span><span class="n">E</span> <span class="s2">&quot;-b 20 --wall-time=3600&quot;</span> <span class="o">--</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span>      <span class="o">--</span><span class="n">memory</span><span class="o">=</span><span class="mi">2000</span> <span class="o">--</span><span class="n">disk</span> <span class="mi">10000</span> <span class="o">-</span><span class="n">dall</span> <span class="o">-</span><span class="n">t</span> <span class="mi">900</span>
</pre></div>
</div>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>-T local</p></td>
<td><p>specifies the mode of execution for the factory</p></td>
</tr>
<tr class="row-odd"><td><p>-w</p></td>
<td><p>minimum number of workers</p></td>
</tr>
<tr class="row-even"><td><p>-W</p></td>
<td><p>maximum number of workers</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>Once the workers are spawned from the factories,you will see message as below</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connected</span> <span class="n">to</span> <span class="n">master</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makeflow Monitor on your Master VM</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">makeflow_monitor</span> <span class="n">main_wf_phase1</span><span class="o">.</span><span class="n">jx</span><span class="o">.</span><span class="n">makeflowlog</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Work_Queue Status to see how many workers are currently connected to the Master</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">work_queue_status</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makeflow Clean up output and logs</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">makeflow</span><span class="o">.</span><span class="n">jx</span><span class="o">.</span><span class="n">args</span><span class="o">.*</span>
</pre></div>
</div>
<p><strong>Connect Workers from HPC</strong></p>
<ul class="simple">
<li><p>Here is a pbs script to connect worker factories from UArizona HPC. Modify the following to add the IP_ADDRESS of your Master VM.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#PBS -W group_list=
#PBS -q windfall
#PBS -l select=1:ncpus=16:mem=24gb
#PBS -l place=pack:shared
#PBS -l walltime=02:00:00
#PBS -l cput=02:00:00
module load unsupported
module load ferng/glibc
module load singularity
export CCTOOLS_HOME=/home/u15/sateeshp/cctools
export PATH=${CCTOOLS_HOME}/bin:$PATH
cd /home/u15/sateeshp/
/home/u15/sateeshp/cctools/bin/work_queue_factory -T local IP_ADDRESS 9123 -w 12 -W 16 --workers-per-cycle 10 --cores=1 -t 900
</pre></div>
</div>
<hr class="docutils" />
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">PhytoOracle</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Michele Cosi.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/old_docs/stereorgb.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>