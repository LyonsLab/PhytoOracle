# PhytoOracle's FlirIr Pipeline

#### Outline

Welcome to PhytoOracle's FlirIr pipeline! This pipeline uses the pre-processing transformers from the [PhytoOracle team](https://github.com/phytooracle) to extract thermal data from image files. 

#### Transformers used
FlirIr uses 3 different transformers for data conversion:

|Order|Transformer|Process
|:-:|:-:|:-:|
1|[flir2tif](https://github.com/phytooracle/flir_bin_to_tif_s11)|Converts bin compressed files to tif|
2|[stitchplots](https://github.com/phytooracle/flir_field_stitch)|Aggregates multiple images into a single orthomosaic|
2|[plotclip](https://github.com/phytooracle/rgb_flir_plot_clip_geojson)|Clips images to the plot|
3|[planttemp](https://github.com/phytooracle/flir_plant_temp)|Extracts individual plant temperatures|

#### Data overview
PhytoOracle's FlirIr requires a metadata file (<metadata>.json) for every compressed image file (<image>.bin). 

#### Setup Guide
+ Go [here](https://github.com/LyonsLab/PhytoOracle/blob/alpha/HPC_Install.md) to launch on an HPC system (tested on the University of Arizona's HPC system).
+ Clone the [coordinates correction](https://github.com/ariyanzri/Lettuce_Image_Stitching)

```
git clone https://github.com/ariyanzri/Lettuce_Image_Stitching
mv Lettuce_Image_stitching ../
``` 

+ Download necessary model files

```
iget -rKVP /iplant/home/shared/phytooracle/season_10_lettuce_yr_2020/level_0/necessary_files/
``` 

+ Edit line 33 of `Lettuce_Image_Stitching/geo_correction_config.txt` to match where the necessary file location is, as well as making sure that `SAVE_NEW_TIFF_FILES` is `True`

```
cd necessary_files/ 
find $(pwd) -maxdepth 1 -type f -name model_weights_2021-01-14_flir_lid_10e.pth  # copy this!
cd ../../Lettuce_Image_stitching
nano geo_correction_config.txt
```

#### Running on the HPC's interactive node

At this point your worker nodes should already be running and you should be in your FlirIr directory within your interactive node. Download the data that you need using:

```
iget -rKVP /iplant/home/shared/terraref/ua-mac/raw_tars/season_10_yr_2020/flirIrCamera/<day>.tar
```

Replace <day> with any day you want to process. Un-tar and move the folder to the FlirIr directory.

```
tar -xvf <day>.tar
mv ./flirIrCamera/<day> ./
```

Then edit your entrypoint.sh on line 4 to reflect the <day> folder you want to process.

Once everything is edited, run the pipeline with ./entrypoint.sh.

#### Running on the Cloud with HPC support

Although very similar to the steps above, to run PhytoOracle on the Cloud with HPC support, there are a few extra steps you have to carry out for data staging before starting the pipeline with ./entrypoint.sh.

Using your favouring editing tool do

```
/etc/nginx/sites-available/phyto_oracle.conf
paste the next snipped and save (changing the highlighted <fields>)

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root <PATH/TO/YOUR/PHYTOORACLE/PIPELINE>;

        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                auth_basic "PhytoOracle Data";
        auth_basic_user_file /etc/apache2/.htpasswd;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
                autoindex on;
        }
}
```

then from within your Transformer directory do ./nginx_reload.sh. Input your password if asked.

Open and edit process_one_set.sh :

delete the # on lines 37 and 38
remove ${HPC_PATH} on lines 24, 25, 28
